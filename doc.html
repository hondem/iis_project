<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0067)https://www.fit.vutbr.cz/study/courses/IIS/private/projekt/doc.html -->
<html class="gr__fit_vutbr_cz">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2" />

    <title>IIS Projekt - PayDay docs</title>
    <style type="text/css">
      table {
        border-collapse: collapse;
      }
      td,
      th {
        border: 1px solid black;
        padding: 0.3em 0.5em;
        text-align: left;
      }
      dt {
        font-weight: bold;
        margin-top: 0.5em;
      }

      .inline-code {
        background-color: #fbe5e1;
        color: #c0341d;
        padding: 2px 4px;
        border-radius: 4px;
      }
    </style>
    <style>
      @media print {
        #ghostery-purple-box {
          display: none !important;
        }
      }
    </style>
  </head>
  <body data-gr-c-s-loaded="true">
    <!-- Zkontrolujte prosím nastavení kódování v hlavièce dokumentu 
     podle pou¾itého editoru -->

    <h1>Mzdy a Personalistika (Payday)</h1>
    <!-- Nahradte názvem svého zadání -->

    <dl>
      <dt>Autoøi</dt>
      <dd>
        Jan Demel
        <!-- Nahraïte skuteèným jménem a e-mailem autora a popisem èinnosti -->
        <a href="mailto:xdemel01@stud.fit.vutbr.cz"
          >xdemel01@stud.fit.vutbr.cz</a
        >
        - Návrh a implementácia api
      </dd>
      <dd>
        Jozef Hru¹ka
        <!-- Nahraïte skuteèným jménem a e-mailem autora a popisem èinnosti -->
        <a href="mailto:xhrusk25@stud.fit.vutbr.cz"
          >xhrusk25@stud.fit.vutbr.cz</a
        >
        - Návrh a implementácia frontendu
      </dd>
      <dd>
        Tomá¹ Korec
        <!-- Nahraïte skuteèným jménem a e-mailem autora a popisem èinnosti -->
        <a href="mailto:xkorec04@stud.fit.vutbr.cz"
          >xkorec04@stud.fit.vutbr.cz</a
        >
        - Návrh a implementácia databázy, výpoètu mzdy
      </dd>
      <dt>URL aplikace</dt>
      <dd>
        <a href="https://iis-project.hruska.now.sh/" target="blank">https://iis-project.hruska.now.sh/ (frontend)</a><br>
        <a href="http://payday-api-2.herokuapp.com/" target="blank">http://payday-api-2.herokuapp.com/ (backend)</a>
      </dd>
    </dl>



    <h2>U¾ivatelé systému pro testování</h2>
    <table>
      <tbody>
        <tr>
          <th>Login</th>
          <th>Heslo</th>
          <th>Role</th>
        </tr>
        <tr>
          <td>admin@test.com</td>
          <td>mysuperpassword</td>
          <td>Administrátor</td>
        </tr>
        <tr>
          <td>accountant@test.com</td>
          <td>mysuperpassword</td>
          <td>Mzdová úèetní</td>
        </tr>
        <tr>
          <td>personalist@test.com</td>
          <td>mysuperpassword</td>
          <td>Personalistka</td>
        </tr>
      </tbody>
    </table>

    
    
    <h2>Use case diagram</h2>
    <dd>
      <a href="https://drive.google.com/open?id=1bmls4FOSS0gETWFHXglth2OC1VUCc-KD" target="blank">https://drive.google.com/open?id=1bmls4FOSS0gETWFHXglth2OC1VUCc-KD</a>
    </dd>



    <h2>Implementace</h2>
    <h3>Frontend</h3>
    <p>Aplikácia je vytvorená kompletne v jazyku TypeScript s vyu¾itím kni¾nice React vo verzii 16.12.0.</p>

    <h4>Server-side rendering</h4>
    Implementovaný framework Next.js, ktorá zabezpeèuje render na strane serveru. Be¾né aplikácie v Reacte a iných JavaScript frameworkoch/kni¾niciach bývajú èasto pomalé, preto¾e
    tvorba DOMu prebieha na strane klienta a¾ po obdr¾aní zdrojového kódu. Framework Next.js umo¾òuje pri nasadení vytvori» optimalizovanú verziu aplikácie rozdelené do viacerých men¹ích balíèkov. Klientovi je u¾ zasielaná predom vytvorená DOM ¹truktúra.

    <h4>Získavanie dát</h4>
    Dáta sú získavané z REST API pomocou kni¾nice Axios, ktorá umo¾òuje jednoducho zasiela» a spracováva» HTTP po¾iadavky. 

    <h4>Uchovávanie dát</h4>
    Dáta sú po prijatí od API uchovávané v globálnom stave aplikácie vytvorem pomocou kni¾nice Redux alebo lokálne vo vnútornom stave jednotlivých komponént.

    <h4>©týly</h4>
    Písané za pomoci kniènice styled-components, ktorá umo¾òuje vyu¾i» benefity ES6 a CSS pre dynamické vytváranie kaskádových ¹týlov. Jadrom ¹týlov v aplikácii je objekt (tzv. téma), ktorá uchováva èasto pou¾ívané hodnoty pre ich jednoduch¹ie znovupou¾itie.
    Aplikácia sa plne prispôsobuje rôznym typom zariadení, testované na viacerých ¹tandardných rozlí¹eniach.

    <h4>Manipulácia s dátami</h4>
    Komplexnej¹ia správa dát je vykonávaná pomocou funkcionálneho programovania a kni¾nice Ramda. 

    <h4>Adresárová ¹truktúra pod</h4>
    <ul>
      <li><strong>pages</strong> - zlo¾ka vyu¾ívaná kni¾nicou Next.js pre file-system routing (ka¾dá defaultne exportovaná komponeta symbolizuje stránku)</li>
      <li><strong>src</strong></li>
      <ul>
        <li><strong>actions</strong> - definícia typov systémových akcii, ktorými je mo¾né manipulova» s globálnym stavom aplikácie</li>
        <li><strong>api</strong> - exportované jednotlivé funkcie vyu¾ívané na komunikáciu s API</li>
        <li><strong>components</strong> - komponenty kni¾nice React</li>
        <li><strong>next</strong> - pomocné funkcie pre serverovú èas» (napríklad overenie, èi má u¾ívateµ prístup k danej stránke)</li>
        <li><strong>reducers</strong> - logika definujúca zmenu globálneho stavu pri odoslaní urèitých akcií</li>
        <li><strong>selectors</strong> - pure functions vyu¾ívané pre jednoduché èítanie globálneho stavu aplikácie</li>
        <li><strong>types</strong> - definované typy pre typovú kontrolu jazyka TypeScript</li>
      </ul>
    </ul>

    <h3>REST API</h3>
    <p>API je implementována v jazyce TypeScript pomocí frameworku Koa (<a href="https://koajs.com/" target="blank">https://koajs.com/</a>). Pro pøipojení do databáze byl pou¾it Knex (<a href="https://knexjs.org/" target="blank">https://knexjs.org/</a>).</p>
    <h4>Adresáøová struktura</h4>
    <ul>
      <li>src (zdrojové soubory)</li>
      <ul>
        <li>config (konfigurace projektu)</li>
        <li>controllers (validace request a volání pøíslu¹né operation s validovanými daty)</li>
        <li>database (setup databáze)</li>
        <ul>
          <li>migrations (migrace databáze)</li>
          <li>models (modely pro práci s knexem)</li>
          <li>seeds (data pro databázi)</li>
        </ul>
        <li>middleware (middlewares - funkce, kterými se ovìøuje request)</li>
        <li>operations (business logika)</li>
        <li>repository (ORM nad databází)</li>
        <li>routes (implementace jednoduchého routeru)</li>
        <li>services (slu¾by, které api vyu¾ívá)</li>
        <li>types (typy do TypeScriptu)</li>
        <li>utils (pomocné funkce)</li>
        <li>validations (validace pomocí jsonschema)</li>
      </ul>
      <li>.eslintrc.js (nastavení pro linter)</li>
      <li>.gitignore</li>
      <li>docker-compose.yaml (nastavení dockeru)</li>
      <li>package.json (informace o api, knihovny a skripty)</li>
      <li>tsconfig.json (konfigurace pro TypeScript)</li>
    </ul>

    <h4>Environment promìnné</h4>
    <p>API pracuje s tìmito env promìnnými:</p>
    <ul>
      <li>PORT - Port, na kterém se aplikace má spustit</li>
      <li>DATABASE_URL - connection string pro pøipojení do databáze</li>
      <li>SECURITY_SECRET_HASH - security hash pro "posolení" hesel v systému</li>
      <li>NODE_ENV - prostøedí, kde je aplikace spu¹tìna</li>
    </ul>

    <p>V pøípadì, ¾e daná promìnná není pøed spu¹tìním definována, pou¾ijou se implicitní hodnoty dané konfigurací v adresáøi <span class="inline-code">./backend/config</span></p>

    <h4>NPM Skripty</h4>
    <p>V souboru ./backend/package.json jsou definovené skripty pro ulehèení práce s API. Pro spu¹tìní tìchto skriptù se musíte nácházet v adresáøi ./backend.<br> Popis skriptù:</p>
    <ul>
      <li>npm run build - zkompiluje projekt z typescriptu do javascriptu</li>
      <li>npm run dev - spustí vývojové prostøedí (nodemon kontroluje zmìny v souborech a automaticky restartuje API)</li>
      <li>npm run lint - spustí lint test (zda kód vyhovuje stylu psaní)</li>
      <li>npm run migrate:latest - spustí migrations</li>
      <li>npm run migrate:make NAZEV_MIGRACE - vytvoøí ve slo¾ce ./backend/src/database/migrations nový soubor migrace</li>
      <li>npm run migrate:rollback - sma¾e celou strukturu databáze</li>
      <li>npm run migrate:down - sma¾e poslední provedenou migraci</li>
      <li>npm run migrate:up - provede následující migraci</li>
      <li>npm run seed:make NAZEV_SEEDU - vytvoøí nový seed</li>
      <li>npm run seed:run - vlo¾í do databáze v¹echny data ze seedu</li>
      <li>npm run docker-build - buildne docker image</li>
    </ul>

    <h4>Migrace databáze</h4>
    <p>Vytvoøení struktury databáze probíhá spu¹tìním pøíkazu <span class=="inline-code">npm run migrate:latest</span>. Tento pøíkaz provede v¹echny migrace, které se nacházejí ve slo¾ce ./backend/src/database/migrations 
    chronologicky podle timestampu na zaèátku souboru.</p>

    <h4>Seedování databáze</h4>
    <p>Pro naplnìní databáze daty slou¾í pøíkaz <span class="inline-code">npm run seed:run</span>. Tento pøíkaz provede seedy, které se nacházejí ve slo¾ce ./backend/src/database/seeds 
    chronologicky podle timestampu na zaèátku soubor. Soubory, které nemají timestamp se vykonají jako poslední.</p>

    <h4>Autentifikace u¾ivatele</h4>
    <p>Pro autentifikaci u¾ivatelù je vyu¾it JWT (json web token). Tento token je vygenerován API pøi pøihlá¹ení. Pro podpis tokenu je vyu¾ito promìnné <span class="inline-code">SECURITY_SECRET_HASH</span> nacházející se v konfiguraèních souborech 
      - viz. sekce o struktuøe adresáøù. Payload tohoto JWT nese údaje o u¾ivateli, jeho oprávnìní a expiraci. Pøi ka¾dém requestu (autorizovaném) na API je vy¾ádáno vyplnìní Authorization hlavièky v HTTP po¾adavku.
    API následnì v závislosti na obsahu JWT vyhodnotí, zda má u¾ivatel pøístup k datùm, èi nikoliv.<br>Systém rozeznává následující oprávnìní:</p>
    <ol>
      <li>ADMIN - administrátor systému - spravuje u¾ivatele, mù¾e v¹echno</li>
      <li>PERSONALIST - personalistka - vkládá nové zamìstnance</li>
      <li>ACCOUNTANT - úèetní - mù¾e upravovat data zamìstnancù, vytváøet mzdové záznamy zamìstnancù, poèítat mzdy</li>
    </ol>

    <h4>API Dependencies</h4>
    <h5>Vývojové dependencies</h5>
    <ol>
      <li>"@strv/eslint-config-node": "^2.1.2"</li>
      <li>"@strv/eslint-config-typescript": "^2.1.3"</li>
      <li>"@types/bluebird": "^3.5.27"</li>
      <li>"@types/kcors": "^2.2.3"</li>
      <li>"@types/koa": "^2.0.50"</li>
      <li>"@types/koa-bodyparser": "^4.3.0"</li>
      <li>"@types/koa-router": "^7.0.42"</li>
      <li>"@types/node": "^12.7.9"</li>
      <li>"@types/pino": "^5.8.10"</li>
      <li>"eslint": "~6.7.1"</li>
      <li>"nodemon": "^1.19.3"</li>
      <li>"ts-node-dev": "^1.0.0-pre.44"</li>
    </ol>

    <h5>Produkèní dependencies</h5>
    <ol>
      <li>"@types/bcrypt": "^3.0.0"</li>
      <li>"@types/bcryptjs": "^2.4.2"</li>
      <li>"@types/jsonschema": "^1.1.1"</li>
      <li>"@types/jsonwebtoken": "^8.3.4"</li>
      <li>"@types/lodash": "^4.14.141"</li>
      <li>"bcryptjs": "^2.4.3"</li>
      <li>"bluebird": "^3.7.0"</li>
      <li>"dotenv": "^8.1.0"</li>
      <li>"jsonschema": "^1.2.4"</li>
      <li>"jsonwebtoken": "^8.5.1"</li>
      <li>"kcors": "^2.2.2"</li>
      <li>"knex": "^0.19.4"</li>
      <li>"koa": "^2.8.2"</li>
      <li>"koa-bodyparser": "^4.2.1"</li>
      <li>"koa-compress": "^3.0.0"</li>
      <li>"koa-router": "^7.4.0"</li>
      <li>"lodash": "^4.17.15"</li>
      <li>"moment": "^2.24.0"</li>
      <li>"objection": "^1.6.11"</li>
      <li>"pg": "^7.12.1"</li>
      <li>"pino": "^5.13.4"</li>
      <li>"pino-pretty": "^3.2.1"</li>
      <li>"ts-node": "^8.4.1"</li>
      <li>"typescript": "^3.6.3"</li>
    </ol>
    
    <h4>Výpoèet mzdy</h4>
    <p>
      Zlo¾ka: /backend/src/services/*<br />
      Jazyk: Python<br />
      vystupy:<br />
      - vypocitane udaje sa zapisu do tabulky mesacneho vypoctu m.vypocet<br />
      ktora obsahuje odobne cislo, obdobie a 2000 znakove pole, do ktoreho sa
      zapisuju vypocitane udaje v zakodovanom tvare <br />
      na poziciu definovanu v takulke m.vektor.<br />
      <br />
      vstupy:<br />
      - aktualne obdobie (za ktore sa pocitaju mzdy)<br />
      - id zamestnanca<br />
      - data v tabulke m.udaje a m.osoba<br />
      - kalendar (kazdy pracovnik ma svoj kalendar definovany v mzdovych
      udajoch) <br />
      - datum nastupu (z kmenovych udajov pracovnika)<br />
      - datum ukoncenia pracovneho pomeru (z kmenovych udajov pracovnika)<br />
      - mzdove udaje (vyfiltrovane aktualne platne podla aktualneho obdobia v
      torom sa pocitaju mzdy)<br />
      - zmenove kody vyfiltrovane pre aktualne obdobie za ktore sa pocitaju
      mzdy<br />
    </p>

    <h3>Databáze</h3>
    <p>ER diagram</p>
    <dd>
      <a href="https://dbdiagram.io/d/5dd43412edf08a25543e1edc" target="blank"
        >https://dbdiagram.io/d/5dd43412edf08a25543e1edc</a
      >
    </dd>

    <h2>Instalace</h2>

    <h3>Softwarové po¾adavky</h3>
    <ul>
      <li>Node v10.16.3</li>
      <li>NPM v6.9.0</li>
      <li>Python v2.7.13 (vèetnì knihovny psycopg2 - <a href="https://pypi.org/project/psycopg2/" target="blank">https://pypi.org/project/psycopg2/</a>)</li>
      <li>Docker v19.03.2</li>
    </ul>

    <h3>Instalace API a databáze</h3>
    <ul>
      <li>pøepnìte se do adresáøe ./backend</li>
      <li>nainstalujte si v¹echny dependencies pøíkazem <span class="inline-code">npm install</span></li>
      <li>zbuildìte images pøíkazem <span class="inline-code">docker-compose build</span></li>
      <li>spus»te databázi a API na pozadí pøíkazem <span class="inline-code">docker-compose up -d api database</span></li>
      <li>mù¾eme se pøesvìdèit, ¾e opravdu do¹lo ke spu¹tìní pøíkazem <span class="inline-code">docker-compose ps</span></li>
      <li>v tuto chvíli ji¾ databáze bì¾í, ale je prázdná. Spustíme migrations, co¾ jsou aditivní úpravy struktury databáze <span class="inline-code">npm run migrate:latest</span></li>
      <li>naplníme databázi daty pøíkazem <span class="inline-code">npm run seed:run</span></li>
    </ul>

    <h3>In¹talácia klienta (frontend)</h3>
    <ol>
      <li>Prepnite sa do adresára ./frontend</li>
      <li>Nain¹talujte si potrebné dependencies príkazom <span class="inline-code">npm install</span></li>
      <li>Zostavte si produkènú verziu frontendu príkazom <span class="inline-code">npm run build</span></li>
      <li>Exportujte ENV obsahujúcu adresu backendu: (napr. <span class="inline-code">API_URL=http://localhost:5000</span>)</li>
      <li>Spustite si Next.js server príkazom <span class="inline-code">npm start</span> (uistite sa, ¾e port 3000 nie je obsadený)</li>
    </ol>


    <h2>Známé problémy</h2>
    <p>
      Pøi prvním spu¹tìní seeds jsou do databáze "natvrdo" vlo¾eny primární klíèe nìkterých tabulek. To zpùsobuje, ¾e se neinkrementuje sekvence generování primárních klíèu a tudí¾ prvních pár 
      requestù na urèité endpointy sel¾e chybou "duplicate key - constraints". Øe¹ením tohoto problému je request nìkolikrát opakovat. Konkrétnì:
      <ul>
        <li>První vytváøení nového zamìstnance: 4x (5. request projde)</li>
        <li>První vytváøení mzdové slo¾ky: relativní vùèi cílovému zamìstnanci  (maximálnì v¹ak 6x)</li>
      </ul>
    </p>
  </body>
</html>
